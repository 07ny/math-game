<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字ゲーム - タイムチャレンジ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding-bottom: 250px; /* キーボードのためのスペースを確保 */
        }
        .container {
            transition: transform 0.3s ease-in-out;
            max-width: 500px;
            margin: 0 auto;
            padding: 24px;
        }
        .container.flash-green {
            animation: flash-green 0.3s ease-in-out;
        }
        .container.flash-red {
            animation: flash-red 0.3s ease-in-out;
        }
        @keyframes flash-green {
            0%, 100% { box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 0 0 0px rgba(74,222,128,0); }
            50% { box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 0 0 10px rgba(74,222,128,0.5); }
        }
        @keyframes flash-red {
            0%, 100% { box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 0 0 0px rgba(239,68,68,0); }
            50% { box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 0 0 10px rgba(239,68,68,0.5); }
        }
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.1s linear;
        }
        .modal {
            transition: all 0.3s ease-in-out;
        }
        .modal-content {
            animation: fadeInScale 0.3s ease-in-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- メインゲームコンテナ -->
    <div id="gameContainer" class="container bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-lg space-y-6">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800">数字ゲーム</h1>
        <p class="text-gray-600 text-center text-sm md:text-base">時間内に合計を入力して連続正解を目指そう！</p>

        <!-- 統計情報 -->
        <div class="flex justify-between items-center text-gray-700 font-semibold text-sm md:text-base">
            <div id="streakDisplay">連続正解: 0</div>
            <div id="levelDisplay">レベル: 1</div>
        </div>

        <!-- 制限時間タイマー -->
        <div class="progress-bar-container">
            <div id="timerBar" class="progress-bar"></div>
        </div>
        <div id="timerDisplay" class="text-center text-xl md:text-2xl font-bold text-blue-600">残り時間: 10 秒</div>

        <!-- 問題表示 -->
        <div id="numbers" class="text-4xl md:text-5xl font-extrabold text-gray-800 text-center tracking-wide"></div>

        <!-- 入力表示エリアと送信ボタン -->
        <div class="flex flex-col md:flex-row gap-4">
            <div id="answerDisplay" class="flex-1 p-4 rounded-xl border-2 border-gray-300 bg-gray-100 text-center text-xl min-h-[56px] flex items-center justify-center"></div>
            <button id="submitBtn"
                    class="bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 active:scale-95">
                送信
            </button>
        </div>

        <!-- ゲーム開始ボタン -->
        <button id="startBtn"
                class="w-full bg-blue-600 text-white font-bold text-xl py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 active:scale-95">
            ゲーム開始
        </button>
    </div>

    <!-- ゲームオーバーモーダル -->
    <div id="gameOverModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">ゲームオーバー！</h2>
            <p class="mb-6 text-gray-600 text-lg">最終スコア: <span id="finalScore" class="font-bold text-blue-600"></span> 連続正解</p>
            <button id="playAgainBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">もう一度プレイ</button>
        </div>
    </div>

    <!-- カスタムキーボード -->
    <div id="keyboard" class="fixed bottom-0 left-0 right-0 bg-gray-200 p-4 border-t-2 border-gray-300 transform translate-y-full transition-transform duration-300 grid grid-cols-3 gap-2">
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="1">1</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="2">2</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="3">3</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="4">4</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="5">5</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="6">6</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="7">7</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="8">8</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="9">9</button>
        <button class="bg-gray-400 text-white text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-500 transition-colors" id="clearBtn">C</button>
        <button class="bg-white text-gray-800 text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-300 transition-colors" data-value="0">0</button>
        <button class="bg-gray-400 text-white text-2xl font-bold rounded-lg p-4 shadow-md active:bg-gray-500 transition-colors" id="backspaceBtn">←</button>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM要素を取得
            const gameContainer = document.getElementById('gameContainer');
            const numbersEl = document.getElementById('numbers');
            const answerDisplay = document.getElementById('answerDisplay');
            const submitBtn = document.getElementById('submitBtn');
            const startBtn = document.getElementById('startBtn');
            const streakDisplay = document.getElementById('streakDisplay');
            const levelDisplay = document.getElementById('levelDisplay');
            const timerBar = document.getElementById('timerBar');
            const timerDisplay = document.getElementById('timerDisplay');
            const gameOverModal = document.getElementById('gameOverModal');
            const finalScore = document.getElementById('finalScore');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const keyboard = document.getElementById('keyboard');

            // ゲームの状態変数
            let numbers = [];
            let streak = 0;
            let level = 1;
            let timerInterval;
            const TIME_LIMIT = 10;
            let timeLeft = TIME_LIMIT;
            let gameActive = false;

            // ゲーム開始
            const startGame = () => {
                gameActive = true;
                streak = 0;
                level = 1;
                hideModal();
                updateStats();
                startBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                answerDisplay.innerText = "";
                keyboard.classList.remove('translate-y-full'); // キーボードを表示
                generateNumbers();
            };

            // 問題を生成
            const generateNumbers = () => {
                numbers = [];
                const digits = Math.min(4 + level - 1, 6);
                for (let i = 0; i < digits; i++) {
                    numbers.push(Math.floor(Math.random() * 9) + 1);
                }
                numbersEl.innerText = numbers.join(" + ");
                resetTimer();
            };

            // タイマーをリセットして開始
            const resetTimer = () => {
                clearInterval(timerInterval);
                timeLeft = TIME_LIMIT;
                timerBar.style.width = '100%';
                timerDisplay.innerText = `残り時間: ${timeLeft} 秒`;

                timerInterval = setInterval(() => {
                    if (!gameActive) {
                        clearInterval(timerInterval);
                        return;
                    }
                    timeLeft--;
                    timerBar.style.width = `${(timeLeft / TIME_LIMIT) * 100}%`;
                    timerDisplay.innerText = `残り時間: ${timeLeft} 秒`;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            };

            // 答えを確認
            const checkAnswer = () => {
                if (!gameActive) return;
                const answer = parseInt(answerDisplay.innerText);
                const sum = numbers.reduce((a, b) => a + b, 0);

                if (answer === sum) {
                    streak++;
                    if (streak % 5 === 0) level++;
                    gameContainer.classList.add('flash-green');
                    setTimeout(() => gameContainer.classList.remove('flash-green'), 300);
                } else {
                    endGame();
                    return; // 不正解の場合はゲーム終了
                }

                answerDisplay.innerText = "";
                updateStats();
                generateNumbers();
            };

            // ゲームオーバー
            const endGame = () => {
                gameActive = false;
                clearInterval(timerInterval);
                showModal();
                finalScore.innerText = streak;
                startBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                keyboard.classList.add('translate-y-full'); // キーボードを非表示
            };

            // モーダルを表示
            const showModal = () => {
                gameOverModal.classList.remove('hidden');
            };

            // モーダルを非表示
            const hideModal = () => {
                gameOverModal.classList.add('hidden');
            };

            // 統計情報を更新
            const updateStats = () => {
                streakDisplay.innerText = `連続正解: ${streak}`;
                levelDisplay.innerText = `レベル: ${level}`;
            };

            // キーボード入力の処理
            keyboard.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.tagName === 'BUTTON' || !gameActive) return;

                const value = target.dataset.value;
                const currentAnswer = answerDisplay.innerText;

                if (value !== undefined) {
                    if (currentAnswer.length < 8) { // 入力桁数を制限
                        answerDisplay.innerText += value;
                    }
                } else if (target.id === 'backspaceBtn') {
                    answerDisplay.innerText = currentAnswer.slice(0, -1);
                } else if (target.id === 'clearBtn') {
                    answerDisplay.innerText = "";
                }
            });

            // イベントリスナー
            startBtn.addEventListener('click', startGame);
            submitBtn.addEventListener('click', checkAnswer);
            playAgainBtn.addEventListener('click', startGame);

            // 初回表示
            updateStats();
            hideModal();
            submitBtn.classList.add('hidden');
            keyboard.classList.add('translate-y-full');
        });
    </script>
</body>
</html>
